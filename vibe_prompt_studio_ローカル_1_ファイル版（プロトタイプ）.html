<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VibePrompt Studio (Neo-Vintage 95)</title>
<style>
  /* ===================================================
     NEW - Retro Future UI v2 (More Win95)
     =================================================== */
  @import url('https://fonts.googleapis.com/css2?family=VT323&family=Inter:wght@400;600;700&display=swap');

  :root {
    /* Win95 inspired color palette */
    --bg-color: #008080;      /* Classic Teal background */
    --panel-bg: #C0C0C0;      /* The classic grey */
    --text-primary: #000000;
    --text-secondary: #808080;
    --border-color-light: #FFFFFF;
    --border-color-dark: #808080;
    --border-color-outer: #000000;

    /* Accents */
    --title-bar-bg: linear-gradient(to right, #000080, #1084d0); /* Classic blue gradient */
    --title-bar-text: #FFFFFF;
    --accent-pink: #f472b6;
    --accent-yellow: #fbbf24;

    /* Sizing */
    --radius: 0px; /* No radius for that classic feel */
    --border-width: 1px;

    /* Typography */
    --font-sans: 'Inter', sans-serif; /* Using a modern readable font is better for editor */
    --font-pixel: 'VT323', monospace;
    --fs-base: 16px;
    --fs-sm: 14px;
    --fs-title: 22px;
  }

  /* ========== Global Styles ========== */
  * { box-sizing: border-box; }
  html, body { height: 100%; }

  body {
    margin: 0;
    background-color: var(--bg-color);
    font-family: var(--font-sans);
    font-size: var(--fs-base);
    color: var(--text-primary);
  }

  /* ========== Header ========== */
  header {
    position: sticky; top: 0; z-index: 100;
    display: flex; align-items: center; gap: 12px;
    padding: 10px 16px;
    background: var(--panel-bg);
    border-bottom: var(--border-width) solid var(--border-color-dark);
  }
  header h1 {
    font-family: var(--font-pixel);
    font-size: var(--fs-title);
    margin: 0;
    font-weight: 400;
  }
  header .sub { font-size: var(--fs-sm); color: var(--text-primary); }
  header .spacer { flex: 1; }

  /* ========== Win95 Style Buttons & Inputs ========== */
  .btn {
    appearance: none;
    background-color: var(--panel-bg);
    border: var(--border-width) solid var(--border-color-dark);
    border-color: var(--border-color-light) var(--border-color-dark) var(--border-color-dark) var(--border-color-light);
    box-shadow: 1px 1px 0 1px var(--border-color-outer);
    padding: 8px 16px;
    font-weight: 600;
    cursor: pointer;
    transition: none;
  }
  .btn:active {
    border-color: var(--border-color-dark) var(--border-color-light) var(--border-color-light) var(--border-color-dark);
    box-shadow: none;
    transform: translate(1px, 1px);
  }
  .btn.primary {
    background: var(--accent-pink);
    color: #fff;
    font-weight: 700;
  }
  select, input[type="number"] {
    border: 2px inset var(--panel-bg);
    background: #fff;
    padding: 6px 10px;
  }

  /* ========== Hamburger Menu ========== */
  .hamburger { position: relative; }
  .menu {
    position: absolute; right: 0; top: 42px;
    min-width: 280px;
    background: var(--panel-bg);
    border: var(--border-width) solid var(--border-color-dark);
    border-color: var(--border-color-light) var(--border-color-dark) var(--border-color-dark) var(--border-color-light);
    box-shadow: 1px 1px 0 1px var(--border-color-outer);
    padding: 4px;
    display: none;
  }
  .menu.open { display: block; }
  .menu .group-title { font-weight: bold; padding: 8px; }

  /* ========== Layout Panes (The "Windows") ========== */
  #container {
    display: flex;
    gap: 16px;
    padding: 16px;
    height: calc(100vh - 60px);
    align-items: stretch;
  }
  .pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--panel-bg);
    border: var(--border-width) solid;
    border-color: var(--border-color-light) var(--border-color-dark) var(--border-color-dark) var(--border-color-light);
    box-shadow: 1px 1px 0 1px var(--border-color-outer);
    overflow: hidden;
  }

  .titlebar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 4px 8px;
    color: var(--title-bar-text);
    background: var(--title-bar-bg);
    cursor: default;
  }
  .titlebar h2 {
    margin: 0;
    font-family: var(--font-sans);
    font-size: var(--fs-sm);
    font-weight: 700;
  }
  .titlebar::after {
    content: '＿ □ ✕';
    font-family: sans-serif;
    font-weight: bold;
    color: var(--panel-bg);
    background: var(--panel-bg);
    padding: 0 4px;
    border: 1px solid;
    border-color: var(--border-color-dark) var(--border-color-light) var(--border-color-light) var(--border-color-dark);
    box-shadow: 1px 1px 0 0px #000;
  }

  .content {
    flex: 1;
    overflow: auto;
    background: #fff; /* White content background */
    margin: 4px;
    border: 2px inset var(--panel-bg);
  }

  /* Editor & Preview Specifics */
  #preview, #final { padding: 16px; }
  #preview h1, #preview h2, #preview h3, #final h1, #final h2, #final h3 {
    border-bottom: 1px solid var(--border-color-dark);
  }
  #preview pre, #preview code, #final pre, #final code {
    background: var(--panel-bg);
    border: 1px solid var(--border-color-dark);
    padding: 8px;
  }
  #final { white-space: pre-wrap; padding: 16px; }

  /* Token bar */
  .meter-container { padding: 8px; }
  .meter {
    height: 20px;
    width: 100%;
    background: var(--panel-bg);
    border: 2px inset var(--panel-bg);
    padding: 2px;
  }
  .meter > span { height: 100%; display: block; width: 0%; background: var(--accent-blue); }
  .stat { font-size: 12px; color: var(--text-primary); display: flex; justify-content: space-between; }

  footer {
    color: var(--text-primary);
    font-size: 12px;
    padding: 8px 16px;
    border-top: 1px solid var(--border-color-dark);
    background: var(--panel-bg);
  }

  /* Split.js gutter */
  .gutter { background-color: var(--panel-bg); }
  .gutter.gutter-horizontal { cursor: col-resize; width: 8px; }

  /* NO MORE RESPONSIVE CHANGE FOR LAYOUT */


  /* ========== Editor Toolbar ========== */
  .editor-toolbar {
    background: var(--panel-bg);
    padding: 4px;
    border-bottom: 1px solid var(--border-color-dark);
    display: flex;
    gap: 4px;
  }
  .toolbar-btn {
    appearance: none;
    background-color: var(--panel-bg);
    border: 1px solid var(--border-color-dark);
    border-color: var(--border-color-light) var(--border-color-dark) var(--border-color-dark) var(--border-color-light);
    padding: 4px 8px;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
  }
  .toolbar-btn:active {
    border-color: var(--border-color-dark) var(--border-color-light) var(--border-color-light) var(--border-color-dark);
  }
  .toolbar-btn b, .toolbar-btn i, .toolbar-btn s {
    font-style: normal;
    font-weight: bold;
    text-decoration: none;
  }

</style>

<!-- Libraries -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css" />
<!-- Light theme に変更 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/theme/eclipse.min.css" />

<script src="https://cdn.jsdelivr.net/npm/split.js@1.6.5/dist/split.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/markdown/markdown.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/edit/closebrackets.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/edit/closetag.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/selection/active-line.min.js"></script>
<script src="https://unpkg.com/js-tiktoken/dist/web/index.js"></script>
</head>

<body>
  <header>
    <h1>VibePrompt Studio <span class="sub">— Local Prototype</span></h1>

    <div class="spacer"></div>

    <!-- よく使う操作だけを表に -->
    <label class="toggle" style="display:flex;align-items:center;gap:8px;">
      <span class="sub">テンプレート</span>
      <select id="tplSelect" title="テンプレート">
        <option value="none">選択してください…</option>
        <option value="general">一般タスク</option>
        <option value="code">コード生成（安全重視）</option>
        <option value="summary">要約・抽出</option>
      </select>
    </label>
    <button id="applyTpl" class="btn">挿入</button>

    <button id="copyFinal" class="btn primary">最終プロンプトをコピー</button>

    <!-- ハンバーガー内に保存/読み込みなど -->
    <div class="hamburger">
      <button id="hamburgerBtn" class="btn hamburger-btn" aria-label="メニュー">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18M3 12h18M3 18h18"/>
        </svg>
      </button>
      <div id="hamburgerMenu" class="menu">
        <div class="group-title">ファイル</div>
        <div class="row"><button id="exportMd" class="btn" style="flex:1">保存（.md）</button></div>
        <div class="row"><button id="exportJson" class="btn" style="flex:1">保存（.json）</button></div>
        <div class="row">
          <input id="importFile" type="file" hidden accept=".md,.txt,.json"/>
          <button id="importBtn" class="btn" style="flex:1">読み込み</button>
        </div>
        <div class="row"><button id="resetBtn" class="btn ghost" style="flex:1">リセット</button></div>

        <div class="group-title">オプション</div>
        <div class="row" style="justify-content:space-between">
          <label class="toggle" style="display:flex;gap:8px;align-items:center;">
            <input id="wrapToggle" type="checkbox"/> Chatタグで包む
          </label>
          <span class="pill" id="status">Tokenizer: 準備中…</span>
        </div>
        <div class="row" style="gap:12px;">
          <label class="toggle" style="display:flex;gap:8px;align-items:center;">
            上限（tokens）
            <input id="limit" type="number" min="512" step="512" value="8192" style="width:110px"/>
          </label>
        </div>
      </div>
    </div>
  </header>

  <div id="container">
    <div id="pane-left" class="pane">
      <div class="titlebar"><h2>Markdown入力</h2><span class="pill">Ctrl/Cmd+S: 保存</span></div>
      <div class="editor-toolbar">
        <button id="btn-bold" class="toolbar-btn" title="太字"><b>B</b></button>
        <button id="btn-italic" class="toolbar-btn" title="斜体"><i>I</i></button>
        <button id="btn-strike" class="toolbar-btn" title="打ち消し線"><s>S</s></button>
        <button id="btn-h1" class="toolbar-btn" title="見出し1">H1</button>
        <button id="btn-link" class="toolbar-btn" title="リンク">Link</button>
        <button id="btn-quote" class="toolbar-btn" title="引用">Quote</button>
        <button id="btn-code" class="toolbar-btn" title="コードブロック">Code</button>
        <button id="btn-list" class="toolbar-btn" title="箇条書き">List</button>
      </div>
      <div class="content"><textarea id="editor"></textarea></div>
    </div>

    

    <div id="pane-right" class="pane">
      <div class="titlebar"><h2>最終プロンプト & トークン見積り</h2></div>
      <div id="final" class="content"></div>
      <div class="meter-container">
        <div class="meter"><span id="meterFill"></span></div>
        <div class="stat"><span id="tokStat">0 tokens</span><span id="pctStat">0%</span></div>
      </div>
    </div>
  </div>

  <footer>
    • このファイルはローカルで完結します。オフライン完全対応が必要な場合はライブラリ同梱版に差し替えてください。 • YAMLフロントマター対応。
  </footer>

<script>
  // ============ Layout ============
  Split(['#pane-left', '#pane-right'], {
    sizes: [50, 50], minSize: 200, gutterSize: 8
  });

  // ============ CodeMirror ============
  const cm = CodeMirror.fromTextArea(document.getElementById('editor'), {
    mode: 'markdown',
    theme: 'eclipse',                // 明るいテーマ
    lineNumbers: true,
    styleActiveLine: true,
    autoCloseBrackets: true,
    autoCloseTags: true,
    lineWrapping: true
  });

  // ============ Menu toggle ============
  const menuBtn = document.getElementById('hamburgerBtn');
  const menu    = document.getElementById('hamburgerMenu');
  menuBtn.addEventListener('click', ()=> menu.classList.toggle('open'));
  document.addEventListener('click', (e)=>{
    if(!menu.contains(e.target) && !menuBtn.contains(e.target)) menu.classList.remove('open');
  });

  // ============ Initial content ============
  const LS_KEY = 'vibeprompt_studio_v1';
  const saved = localStorage.getItem(LS_KEY);
  if (saved) {
    try { cm.setValue(JSON.parse(saved).markdown || ''); } catch {}
  } else {
    cm.setValue(getTemplate('general'));
  }

  // ============ Markdown -> HTML ============
  marked.setOptions({ breaks: true, gfm: true, mangle: false, headerIds: true });
  const finalEl   = document.getElementById('final');
  const statusEl  = document.getElementById('status');
  const meterFill = document.getElementById('meterFill');
  const tokStat   = document.getElementById('tokStat');
  const pctStat   = document.getElementById('pctStat');

  function renderFinalMarkdown(markdown) {
    const dirty = marked.parse(markdown);
    finalEl.innerHTML = DOMPurify.sanitize(dirty);
  }

  // ============ Front matter ============
  function parseFrontmatter(md){
    const fm = { data:{}, body: md };
    const m = md.match(/^---\n([\s\S]*?)\n---\n?/);
    if(m){
      try{ fm.data = jsyaml.load(m[1]) || {}; }catch(e){ console.warn('YAML parse error', e); }
      fm.body = md.slice(m[0].length);
    }
    return fm;
  }
  function buildSystemBlock(data){
    const lines=[];
    if(data.role) lines.push(`役割: ${String(data.role)}`);
    if(data.goal) lines.push(`目的: ${String(data.goal)}`);
    if (Array.isArray(data.constraints)){
      lines.push('制約:'); data.constraints.forEach(c=>lines.push(`- ${c}`));
    } else if (data.constraints){ lines.push(`制約: ${data.constraints}`); }
    if (Array.isArray(data.style)){
      lines.push('記述スタイル:'); data.style.forEach(s=>lines.push(`- ${s}`));
    } else if (data.style){ lines.push(`記述スタイル: ${data.style}`); }
    if (Array.isArray(data.output_format)){
      lines.push('出力形式:'); data.output_format.forEach(s=>lines.push(`- ${s}`));
    } else if (data.output_format){ lines.push(`出力形式: ${data.output_format}`); }
    if (data.eval_check) lines.push(`自己点検: ${String(data.eval_check)}`);
    return lines.join('\n');
  }
  function buildFinalPrompt(md, wrap){
    const fm = parseFrontmatter(md);
    if(!wrap) return md;
    const sys = buildSystemBlock(fm.data);
    const body = fm.body.trim();
    const sysBlock = sys.trim().length ? `\n<start_of_turn>system\n${sys}\n<end_of_turn>\n` : '';
    return `${sysBlock}<start_of_turn>user\n${body}\n<end_of_turn>`;
  }

  // ============ Tokenizer ============
  let enc=null;
  async function initTokenizer(){
    try{
      if(!window.tiktoken) throw new Error('tiktoken not loaded');
      enc = await window.tiktoken.get_encoding('cl100k_base');
      statusEl.textContent='Tokenizer: cl100k_base';
      statusEl.style.color='#1f8f5f';
    }catch(e){
      enc=null; statusEl.textContent='Tokenizer: 近似で計算'; statusEl.style.color='#b27a00';
    }
  }
  initTokenizer();

  function estimateTokens(text){
    try{ if(enc) return enc.encode(text).length; }catch{}
    return Math.ceil(text.trim().length/3); // fallback
  }

  function updateAll(){
    const md = cm.getValue();
    const wrap  = document.getElementById('wrapToggle').checked;
    const final = buildFinalPrompt(md, wrap);
    renderFinalMarkdown(final);

    const used  = estimateTokens(final);
    const limit = Math.max(512, Number(document.getElementById('limit').value || 8192));
    const pct   = Math.min(100, Math.round(used/limit*100));
    meterFill.style.width = pct + '%';
    meterFill.style.background = pct >= 95
      ? 'linear-gradient(90deg, var(--warn), var(--danger))'
      : 'linear-gradient(90deg, var(--accent), var(--brand))';
    tokStat.textContent = `${used.toLocaleString()} tokens`;
    pctStat.textContent = `${pct}%`;

    try{ localStorage.setItem(LS_KEY, JSON.stringify({ markdown: md, wrap, limit })); }catch{}
  }

  cm.on('change', debounce(updateAll, 120));
  document.getElementById('wrapToggle').addEventListener('change', updateAll);
  document.getElementById('limit').addEventListener('change', updateAll);

  function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; }

  // ============ Templates ============
  function getTemplate(name){
    if(name==='code') return `---
role: "あなたは一流のソフトウェアエンジニア兼セキュリティ実務家"
goal: "安全で保守可能な実装と説明を提示する"
constraints:
  - 事実ベース。根拠が曖昧なときは明示
  - 脆弱な書き方（XSS/SQLi/コマンド注入等）は避け、理由を解説
  - ライセンス/依存の注意点に触れる
style: ["番号見出し","簡潔なコードブロック","表による比較"]
output_format: ["手順","コード","要点の箇条書き"]
eval_check: "要件・非機能要件・セキュリティの観点で自己点検し、最後に合否と改善案を述べる"
---
# タスク
- 目的: {ここに達成したいこと}
- 前提: {環境/フレームワーク/制約}
- 成功条件: {テスト/性能/保守性など}

## 追加情報
- 参照仕様や既存コードの注意点など
`;
    if(name==='summary') return `---
role: "あなたは厳密な要約・抽出の専門家"
goal: "与えられた本文から指示どおりに情報を抽出する"
constraints:
  - 逸脱・推測・脚色をしない
  - 数値・固有名詞は原文どおり
style: ["箇条書き","短文","見出し付き"]
output_format: ["要点3つ","引用部分は引用符で"]
eval_check: "過不足・誤り・主観混入がないか自己点検し、不明は不明と記す"
---
# 入力テキスト
(ここに本文)

# 指示
- 要点3つ
- 固有名詞の一覧
- 重要な数値
`;
    return `---
role: "あなたは{分野}の専門家"
goal: "誰に何をどの形式で届けるかを一文で"
constraints:
  - 事実ベース/出典明記
  - トーン: 簡潔・実務志向
inputs:
  - 背景: {状況}
  - 対象読者: {誰に}
  - 参照資料: {URL等}
style: ["番号付き見出し","表を活用"]
output_format: ["見出し","手順","表"]
eval_check: "要件を満たしているか最後に自己点検して報告"
---
# タスク
1) 目的 / 2) 前提 / 3) 出力仕様…をMarkdownで記入
`;
  }

  document.getElementById('applyTpl').addEventListener('click', ()=>{
    const name = document.getElementById('tplSelect').value;
    if(name==='none') return;
    const tpl = getTemplate(name);
    const current = cm.getValue().trim();
    if(current && !confirm('現在の内容をテンプレートで置き換えますか？')) return;
    cm.setValue(tpl); cm.focus();
    cm.setCursor({line: cm.lineCount()-1, ch: 0});
    updateAll();
  });

  // ============ Export / Import / Copy ============
  function download(filename, text, type='text/plain'){
    const blob=new Blob([text],{type}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }
  document.getElementById('exportMd').addEventListener('click', ()=>{
    download(`prompt_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.md`,
             cm.getValue(), 'text/markdown');
  });
  document.getElementById('exportJson').addEventListener('click', ()=>{
    const data={ markdown: cm.getValue(),
                 wrap: document.getElementById('wrapToggle').checked,
                 limit: Number(document.getElementById('limit').value) };
    download(`prompt_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`,
             JSON.stringify(data,null,2), 'application/json');
  });

  document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
  document.getElementById('importFile').addEventListener('change', (ev)=>{
    const f=ev.target.files[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        if(f.name.endsWith('.json')){
          const obj=JSON.parse(reader.result);
          if(obj.markdown) cm.setValue(obj.markdown);
          if(typeof obj.wrap === 'boolean') document.getElementById('wrapToggle').checked=obj.wrap;
          if(obj.limit) document.getElementById('limit').value=obj.limit;
        }else{
          cm.setValue(String(reader.result));
        }
        updateAll();
      }catch(e){ alert('読み込みに失敗しました: '+e.message); }
    };
    reader.readAsText(f); ev.target.value='';
  });

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    if(!confirm('ローカル保存内容を削除し、初期テンプレートに戻します。よろしいですか？')) return;
    localStorage.removeItem(LS_KEY);
    cm.setValue(getTemplate('general'));
    document.getElementById('wrapToggle').checked=false;
    document.getElementById('limit').value=8192;
    updateAll();
  });

  document.getElementById('copyFinal').addEventListener('click', async ()=>{
    const text = finalEl.textContent;
    try{ await navigator.clipboard.writeText(text); flash('コピーしました'); }
    catch(e){
      const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy'); ta.remove(); flash('コピーしました');
    }
  });

  // shortcuts
  document.addEventListener('keydown',(e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){
      e.preventDefault(); flash('ローカルに保存しました'); updateAll();
    }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='b'){
      e.preventDefault(); document.getElementById('copyFinal').click();
    }
  });

  function flash(msg){
    const pill=document.createElement('div');
    pill.textContent=msg;
    Object.assign(pill.style,{
      position:'fixed', right:'16px', bottom:'16px',
      background:'#ffffff', border:'1px solid var(--border)', padding:'10px 14px',
      borderRadius:'12px', fontSize:'12px', boxShadow: 'var(--shadow)'
    });
    document.body.appendChild(pill); setTimeout(()=>pill.remove(), 1200);
  }

  // ============ Editor Toolbar Logic ============  function setupToolbar(editor) {    const wrapSelection = (prefix, suffix = prefix) => {      const selection = editor.getSelection();      editor.replaceSelection(prefix + selection + suffix);      editor.focus();    };    document.getElementById('btn-bold').addEventListener('click', () => wrapSelection('**'));    document.getElementById('btn-italic').addEventListener('click', () => wrapSelection('*'));    document.getElementById('btn-strike').addEventListener('click', () => wrapSelection('~~'));    document.getElementById('btn-h1').addEventListener('click', () => {      const line = editor.getCursor().line;      const content = editor.getLine(line);      editor.setLine(line, '# ' + content);      editor.focus();    });    document.getElementById('btn-link').addEventListener('click', () => {      const selection = editor.getSelection();      const url = prompt('リンク先のURLを入力してください:', 'https://');      if (url) {        editor.replaceSelection(`[${selection || 'リンクテキスト'}](${url})`);      }      editor.focus();    });    document.getElementById('btn-quote').addEventListener('click', () => {      const line = editor.getCursor().line;      const content = editor.getLine(line);      editor.setLine(line, '> ' + content);      editor.focus();    });    document.getElementById('btn-code').addEventListener('click', () => {      wrapSelection('\n```\n', '\n```\n');    });    document.getElementById('btn-list').addEventListener('click', () => {      const selection = editor.getSelection();      const lines = selection.split('\n').map(line => '- ' + line);      editor.replaceSelection(lines.join('\n'));      editor.focus();    });  }  setupToolbar(cm);  // first render
  updateAll();

  // cleanup
  window.addEventListener('unload', ()=>{ try{ if(enc) enc.free(); }catch{} });
</script>
</body>
</html>
